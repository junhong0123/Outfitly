@model Outfitly.Models.CheckoutViewModel
@{
    ViewData["Title"] = "Checkout";
}

<!-- Page Header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl md:text-4xl font-light text-black mb-6">Checkout</h1>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center gap-4">
            <div class="flex items-center">
                <div class="step-indicator active flex items-center justify-center w-8 h-8 rounded-full bg-black text-white text-sm font-medium">1</div>
                <span class="ml-2 text-sm font-medium text-black hidden sm:inline">Shipping</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="step-indicator flex items-center justify-center w-8 h-8 rounded-full bg-gray-200 text-gray-500 text-sm font-medium">2</div>
                <span class="ml-2 text-sm text-gray-500 hidden sm:inline">Payment</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="step-indicator flex items-center justify-center w-8 h-8 rounded-full bg-gray-200 text-gray-500 text-sm font-medium">3</div>
                <span class="ml-2 text-sm text-gray-500 hidden sm:inline">Review</span>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Content -->
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <form id="checkoutForm" asp-action="PlaceOrder" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="SelectedAddressId" />
        <input type="hidden" asp-for="SaveNewAddress" id="saveNewAddress" />
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Checkout Form -->
            <div class="lg:col-span-2">

                <!-- Step 1: Shipping Address -->
                <div id="step1" class="checkout-step bg-white border border-gray-200 rounded p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-medium text-black">Shipping Address</h2>
                        <span class="text-xs bg-black text-white px-3 py-1 rounded-full">STEP 1</span>
                    </div>

                    @if (Model.SavedAddresses.Any())
                    {
                        <!-- Saved Addresses -->
                        <div class="mb-6">
                            <h3 class="text-xs font-medium text-gray-700 mb-3 tracking-wide">SAVED ADDRESSES</h3>
                            <div class="space-y-3">
                                @foreach (var addr in Model.SavedAddresses)
                                {
                                    <label class="saved-address-label flex items-start p-4 border-2 rounded cursor-pointer hover:border-gray-400 @(Model.SelectedAddressId == addr.Id ? "border-black bg-gray-50" : "border-gray-300")">
                                        <input type="radio" name="addressChoice" value="@addr.Id" 
                                               class="saved-address-radio w-4 h-4 mt-1 text-black" @(Model.SelectedAddressId == addr.Id ? "checked" : "")
                                               data-id="@addr.Id"
                                               data-firstname="@addr.FirstName"
                                               data-lastname="@addr.LastName"
                                               data-address1="@addr.AddressLine1"
                                               data-address2="@(addr.AddressLine2 ?? "")"
                                               data-city="@addr.City"
                                               data-state="@addr.StateProvince"
                                               data-zip="@addr.ZipPostalCode"
                                               data-country="@addr.Country"
                                               data-phone="@(addr.PhoneNumber ?? "")">
                                        <div class="ml-3">
                                            <p class="text-sm font-medium text-black">@addr.FirstName @addr.LastName</p>
                                            <p class="text-sm text-gray-600">@addr.AddressLine1@(string.IsNullOrEmpty(addr.AddressLine2) ? "" : ", " + addr.AddressLine2)</p>
                                            <p class="text-sm text-gray-600">@addr.City, @addr.StateProvince @addr.ZipPostalCode</p>
                                            <p class="text-sm text-gray-600">@addr.Country</p>
                                            @if (addr.IsDefault)
                                            {
                                                <span class="text-xs text-green-600 font-medium">Default</span>
                                            }
                                        </div>
                                    </label>
                                }
                                @if (Model.SavedAddresses.Count < 3)
                                {
                                    <label class="flex items-center p-4 border-2 border-gray-300 rounded cursor-pointer hover:border-gray-400">
                                        <input type="radio" name="addressChoice" value="new" class="w-4 h-4 text-black" onchange="showNewAddressForm()">
                                        <span class="ml-3 text-sm text-gray-700">+ Add new address</span>
                                    </label>
                                }
                            </div>
                        </div>
                    }

                    <!-- New Address Form -->
                    <div id="newAddressForm" class="@(Model.SavedAddresses.Any() ? "hidden" : "") space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">FIRST NAME *</label>
                                <input type="text" asp-for="ShippingAddress.FirstName" required
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">LAST NAME *</label>
                                <input type="text" asp-for="ShippingAddress.LastName" required
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">EMAIL *</label>
                            <input type="email" asp-for="ShippingAddress.Email" required
                                   class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">PHONE NUMBER *</label>
                            <input type="tel" asp-for="ShippingAddress.PhoneNumber" required
                                   class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">ADDRESS LINE 1 *</label>
                            <input type="text" asp-for="ShippingAddress.AddressLine1" required
                                   class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">ADDRESS LINE 2</label>
                            <input type="text" asp-for="ShippingAddress.AddressLine2"
                                   class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">CITY *</label>
                                <input type="text" asp-for="ShippingAddress.City" required
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">STATE/PROVINCE *</label>
                                <input type="text" asp-for="ShippingAddress.StateProvince" required
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">ZIP/POSTAL CODE *</label>
                                <input type="text" asp-for="ShippingAddress.ZipPostalCode" required
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">COUNTRY *</label>
                                <select asp-for="ShippingAddress.Country" required
                                        class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                                    <option value="">Select Country</option>
                                    <option value="United States">United States</option>
                                    <option value="Malaysia">Malaysia</option>
                                    <option value="Singapore">Singapore</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="China">China</option>
                                </select>
                            </div>
                        </div>

                        @if (Model.SavedAddresses.Count < 3)
                        {
                            <div class="flex items-center">
                                <input type="checkbox" id="saveAddressCheckbox" class="w-4 h-4 text-black rounded" onchange="document.getElementById('saveNewAddress').value = this.checked">
                                <label for="saveAddressCheckbox" class="ml-2 text-sm text-gray-700">Save this address for future orders</label>
                            </div>
                        }
                    </div>

                    <button type="button" id="continueToPayment"
                            class="w-full bg-black text-white py-3 text-sm tracking-wide hover:bg-gray-800 transition rounded mt-6">
                        CONTINUE TO PAYMENT
                    </button>
                </div>

                <!-- Step 2: Payment Method -->
                <div id="step2" class="checkout-step hidden bg-white border border-gray-200 rounded p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-medium text-black">Payment Method</h2>
                        <span class="text-xs bg-black text-white px-3 py-1 rounded-full">STEP 2</span>
                    </div>

                    <!-- Payment Options -->
                    <div class="space-y-4 mb-6">
                        <label class="flex items-center p-4 border-2 border-black rounded cursor-pointer bg-gray-50">
                            <input type="radio" asp-for="PaymentInfo.PaymentMethod" value="card" checked class="w-4 h-4 text-black">
                            <span class="ml-3 text-sm font-medium text-black">Credit/Debit Card</span>
                            <div class="ml-auto flex gap-2">
                                <div class="w-8 h-5 bg-gray-300 rounded text-xs flex items-center justify-center">V</div>
                                <div class="w-8 h-5 bg-gray-300 rounded text-xs flex items-center justify-center">M</div>
                            </div>
                        </label>

                        <label class="flex items-center p-4 border-2 border-gray-300 rounded cursor-pointer hover:border-gray-400">
                            <input type="radio" asp-for="PaymentInfo.PaymentMethod" value="paypal" class="w-4 h-4 text-black">
                            <span class="ml-3 text-sm text-gray-700">PayPal</span>
                        </label>
                    </div>

                    <!-- Card Details Form -->
                    <div id="cardDetails" class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">CARD NUMBER *</label>
                            <input type="text" asp-for="PaymentInfo.CardNumber" placeholder="1234 5678 9012 3456"
                                   class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">CARDHOLDER NAME *</label>
                            <input type="text" asp-for="PaymentInfo.CardholderName"
                                   class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">EXPIRY DATE *</label>
                                <input type="text" asp-for="PaymentInfo.ExpiryDate" placeholder="MM/YY"
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">CVV *</label>
                                <input type="text" asp-for="PaymentInfo.CVV" placeholder="123"
                                       class="w-full border border-gray-300 rounded px-4 py-2.5 text-sm focus:outline-none focus:border-black">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button type="button" id="backToShipping"
                                class="flex-1 border border-gray-300 text-black py-3 text-sm hover:bg-gray-50 transition rounded">
                            BACK
                        </button>
                        <button type="button" id="continueToReview"
                                class="flex-1 bg-black text-white py-3 text-sm tracking-wide hover:bg-gray-800 transition rounded">
                            CONTINUE TO REVIEW
                        </button>
                    </div>
                </div>

                <!-- Step 3: Review Order -->
                <div id="step3" class="checkout-step hidden bg-white border border-gray-200 rounded p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-medium text-black">Review Your Order</h2>
                        <span class="text-xs bg-black text-white px-3 py-1 rounded-full">STEP 3</span>
                    </div>

                    <!-- Shipping Address Review -->
                    <div class="mb-6 pb-6 border-b border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xs font-medium text-black tracking-wide">SHIPPING ADDRESS</h3>
                            <button type="button" onclick="showStep(1)" class="text-xs text-gray-600 hover:text-black underline">Edit</button>
                        </div>
                        <p id="reviewAddress" class="text-sm text-gray-700">
                            @Model.ShippingAddress.FirstName @Model.ShippingAddress.LastName<br>
                            @Model.ShippingAddress.AddressLine1<br>
                            @Model.ShippingAddress.City, @Model.ShippingAddress.StateProvince @Model.ShippingAddress.ZipPostalCode<br>
                            @Model.ShippingAddress.Country
                        </p>
                    </div>

                    <!-- Order Items -->
                    <div class="mb-6">
                        <h3 class="text-xs font-medium text-black tracking-wide mb-4">ORDER ITEMS</h3>
                        <div class="space-y-3">
                            @foreach (var item in Model.Cart.Items)
                            {
                                <div class="flex gap-3">
                                    <div class="w-16 h-16 bg-gray-100 rounded flex-shrink-0 overflow-hidden">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" alt="@item.ProductName" class="w-full h-full object-cover">
                                        }
                                    </div>
                                    <div class="flex-grow">
                                        <p class="text-sm text-black">@item.ProductName</p>
                                        <p class="text-xs text-gray-600">Qty: @item.Quantity</p>
                                    </div>
                                    <p class="text-sm text-black">$@item.TotalPrice.ToString("F2")</p>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" id="backToPayment"
                                class="flex-1 border border-gray-300 text-black py-3 text-sm hover:bg-gray-50 transition rounded">
                            BACK
                        </button>
                        <button type="submit" id="placeOrderBtn"
                                class="flex-1 bg-black text-white py-3 text-sm tracking-wide hover:bg-gray-800 transition rounded">
                            PLACE ORDER
                        </button>
                    </div>
                </div>

            </div>

            <!-- Right: Order Summary (Sticky) -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-200 rounded p-6 sticky top-24">
                    <h2 class="text-lg font-medium text-black mb-6">Order Summary</h2>

                    <!-- Cart Items Preview -->
                    <div class="space-y-3 mb-6 pb-6 border-b border-gray-200 max-h-48 overflow-y-auto">
                        @foreach (var item in Model.Cart.Items)
                        {
                            <div class="flex gap-2">
                                <div class="w-12 h-12 bg-gray-100 rounded flex-shrink-0 overflow-hidden">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <img src="@item.ImageUrl" alt="@item.ProductName" class="w-full h-full object-cover">
                                    }
                                </div>
                                <div class="flex-grow min-w-0">
                                    <p class="text-xs text-black truncate">@item.ProductName</p>
                                    <p class="text-xs text-gray-500">Qty: @item.Quantity</p>
                                </div>
                                <p class="text-xs text-black flex-shrink-0">$@item.TotalPrice.ToString("F2")</p>
                            </div>
                        }
                    </div>

                    <!-- Summary Details -->
                    <div class="space-y-3 mb-6 pb-6 border-b border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="text-black font-medium">$@Model.Cart.Subtotal.ToString("F2")</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Shipping</span>
                            <span class="text-black font-medium">@(Model.Cart.Shipping == 0 ? "Free" : "$" + Model.Cart.Shipping.ToString("F2"))</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Tax</span>
                            <span class="text-black font-medium">$@Model.Cart.Tax.ToString("F2")</span>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-base font-medium text-black">Total</span>
                        <span class="text-2xl font-light text-black">$@Model.Cart.Total.ToString("F2")</span>
                    </div>

                    <!-- Security Notice -->
                    <div class="bg-gray-50 border border-gray-200 rounded p-4">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            <div>
                                <p class="text-xs font-medium text-black mb-1">Secure Checkout</p>
                                <p class="text-xs text-gray-600">Your payment information is encrypted and secure.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Step navigation
        const steps = {
            1: document.getElementById('step1'),
            2: document.getElementById('step2'),
            3: document.getElementById('step3')
        };

        const stepIndicators = document.querySelectorAll('.step-indicator');
        let currentStep = 1;

        function showStep(stepNumber) {
            Object.values(steps).forEach(step => step.classList.add('hidden'));
            steps[stepNumber].classList.remove('hidden');

            stepIndicators.forEach((indicator, index) => {
                const stepNum = index + 1;
                if (stepNum <= stepNumber) {
                    indicator.classList.add('bg-black', 'text-white');
                    indicator.classList.remove('bg-gray-200', 'text-gray-500');
                } else {
                    indicator.classList.remove('bg-black', 'text-white');
                    indicator.classList.add('bg-gray-200', 'text-gray-500');
                }
            });

            currentStep = stepNumber;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Saved address selection via data attributes
        document.querySelectorAll('.saved-address-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const id = this.dataset.id;
                const firstName = this.dataset.firstname;
                const lastName = this.dataset.lastname;
                const addr1 = this.dataset.address1;
                const addr2 = this.dataset.address2 || '';
                const city = this.dataset.city;
                const state = this.dataset.state;
                const zip = this.dataset.zip;
                const country = this.dataset.country;
                const phone = this.dataset.phone || '';
                
                document.getElementById('SelectedAddressId').value = id;
                document.getElementById('ShippingAddress_FirstName').value = firstName;
                document.getElementById('ShippingAddress_LastName').value = lastName;
                document.getElementById('ShippingAddress_AddressLine1').value = addr1;
                document.getElementById('ShippingAddress_AddressLine2').value = addr2;
                document.getElementById('ShippingAddress_City').value = city;
                document.getElementById('ShippingAddress_StateProvince').value = state;
                document.getElementById('ShippingAddress_ZipPostalCode').value = zip;
                document.getElementById('ShippingAddress_Country').value = country;
                document.getElementById('ShippingAddress_PhoneNumber').value = phone;
                document.getElementById('newAddressForm').classList.add('hidden');
                document.getElementById('saveNewAddress').value = 'false';
            });
        });

        // Show new address form
        function showNewAddressForm() {
            document.getElementById('SelectedAddressId').value = '';
            document.getElementById('newAddressForm').classList.remove('hidden');
        }

        // Step navigation buttons
        document.getElementById('continueToPayment').addEventListener('click', function() {
            showStep(2);
        });

        document.getElementById('backToShipping').addEventListener('click', function() {
            showStep(1);
        });

        document.getElementById('continueToReview').addEventListener('click', function() {
            // Update review section with current address data
            const firstName = document.getElementById('ShippingAddress_FirstName').value;
            const lastName = document.getElementById('ShippingAddress_LastName').value;
            const addr1 = document.getElementById('ShippingAddress_AddressLine1').value;
            const city = document.getElementById('ShippingAddress_City').value;
            const state = document.getElementById('ShippingAddress_StateProvince').value;
            const zip = document.getElementById('ShippingAddress_ZipPostalCode').value;
            const country = document.getElementById('ShippingAddress_Country').value;
            
            document.getElementById('reviewAddress').innerHTML = 
                `${firstName} ${lastName}<br>${addr1}<br>${city}, ${state} ${zip}<br>${country}`;
            
            showStep(3);
        });

        document.getElementById('backToPayment').addEventListener('click', function() {
            showStep(2);
        });

        // Payment method selection
        document.querySelectorAll('input[name="PaymentInfo.PaymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('label').forEach(label => {
                    if (label.querySelector('input[name="PaymentInfo.PaymentMethod"]')) {
                        label.classList.remove('border-black', 'bg-gray-50');
                        label.classList.add('border-gray-300');
                    }
                });

                this.closest('label').classList.add('border-black', 'bg-gray-50');
                this.closest('label').classList.remove('border-gray-300');

                const cardDetails = document.getElementById('cardDetails');
                if (this.value === 'card') {
                    cardDetails.classList.remove('hidden');
                } else {
                    cardDetails.classList.add('hidden');
                }
            });
        });

        // Update cart count after order
        if (window.updateCartCount) {
            window.updateCartCount();
        }
    </script>
}